<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stern Gerlach Experiment</title>

    <style>

        body {
            font-family: sans-serif;
            font-size:15px;
            width:1100px;
            margin-left:auto;
            margin-right:auto;
            background-color:#c5e2ff;
        }

        h1 {
            font-size:32px;
            text-align:center;
            color:Navy;
        }

        #canvas-container {
            margin: auto;
            display: flex;
            justify-content: center;    /* Center canvas horizontally.  */
            align-items: center;        /* Center canvas vertically.    */
        }

    </style>
</head>

<body>
    <h1>
        Stern-Gerlach Experiment
    </h1>

    <div id="canvas-container">
    </div>

    <script>
        /* CANVAS */
        let canvas;
        let canvas_width = 1400;
        let canvas_height = 600;
        let bg_color = 245;
        let stroke_weight = 0.1;

        /* INTERACTIVE COMPONENETS */
        let reset_button;
        let reset_button_x = canvas_width/2 - 120;
        let reset_button_y = canvas_height + 100;
        let fire_button;
        let fire_button_x;
        let fire_button_y;
        let atom_speed_slider;
        let atom_speed_slider_x;
        let atom_speed_slider_y;
        let angle_slider;
        let angle_slider_x;
        let angle_slider_y;
        let angle_display;
        let angle_display_x;
        let angle_display_y;
        let counter;
        let counter_x;
        let counter_y;
        let percent_counter;
        let percent_counter_x;
        let percent_counter_y; 
        let atom_source_select;
        let autofire_checkbox;

        /* STATES */
        let fire = false;
        let autofire = false;
        let spin_chosen = false;
        let up = 1/2;
        let down = -1/2;
        let atom_source = 'Oven';
        let num_spin_up = 0;
        let num_spin_down = 0;

        /* PLATFORM */
        let platform = {
            length:  500,
            width:   500,
            height:  -100
        };

        /* OVEN */
        let oven = {
            x:      -platform.length/2, 
            y:      0, 
            z:      0,
            length: 50, 
            width:  50, 
            height: 50
        };

        /* DETECTOR SCREEN */
        let detector = {
            x:      platform.length/2, 
            y:      0, 
            z:      0, 
            width:  100, 
            height: 160,
            angle:  90
        };

        /* PERSPECTIVE LINE */
        let perspective_line = {
            p1: {
                x: oven.x,
                y: 0,
                z: 0
            },
            p2: {
                x: detector.x,
                y: 0,
                z: 0
            }
        };

        /* MAGNET */
        let magnet = {
            length:     150,
            width:      40,
            height:     30,
            entrance_x: -150/2, // - magnet length / 2
            exit_x:     150/2,
            gap:        90,
            angle:      90
        };

        /* ATOM */ 
        let atom = {
            // Sphere Attributes
            radius:     10,
            detailX:    8,
            detailY:    8,
            // Properties
            spin:       0,
            speed:      1,
            min_speed:  1, 
            max_speed:  50,
            // Coordinates
            pos: { // Current position of atom
                x: 0,
                y: 0,
                z: 0
            },
            start: { // Starting position of atom
                x: oven.x,
                y: 0,
                z: 0
            },
            end: { // End position of atom
                x: detector.x,
                y: 50,
                z: 0
            }
        };

        /* ATOM TRAJECTORY */
        let trajectory = {
            start:  atom.start,

            p1: { // Bezier curve control point 1
                x: magnet.entrance_x + 50, // Start curving atom at magnet entrance
                y: 0,
                z: 0
            },
            p2: { // Bezier curve control point 2
                x: magnet.exit_x, // Arbitrary, but this x value makes a good curve
                y: 0,
                z: 0
            },
            end:    atom.end
        };

        /* Setup the canvas */
        function setup() {
            canvas_width = 0.9 * windowWidth;
            canvas_height = 0.8 * windowHeight;
            canvas = createCanvas(canvas_width, canvas_height, WEBGL);
            canvas.parent("canvas-container");
            angleMode(DEGREES);
            // debugMode(100, 10, 0, 0, 0, 20, -250, -100, 0);
            setupInteractiveComponents();
            resetAtom();
        }

        /* Draw onto the canvas */
        function draw() {
            background(bg_color);
            orbitControl(.50, .50, .03);

            drawPerspectiveLine();
            drawPlatform();            
            drawAtomSource();
            drawDetectorScreen();
            drawMagnet();
            if (fire) // Fire the atom normally
                fireAtom(atom.spin);
            else if (!fire) // Draw atom stuck to detector screen
                drawAtom(atom.spin, atom.pos.x, atom.pos.y, atom.pos.z);
            drawHTML();
        }

        function setupInteractiveComponents() {
            let h = 0.95*windowHeight;
            let w = windowWidth/2;
            reset_button = createButton('Reset');
            reset_button.position(w - 120, h);
            reset_button.mousePressed(reset);

            fire_button = createButton('Fire Atom');
            fire_button.position(w - 50, h);
            fire_button.mousePressed(fireSingleAtom);

            // atom_radius_slider = createSlider(1, 15, 5);
            // atom_radius_slider.position(10, height + 5);
            // atom_radius_slider.style('width', '80px');

            atom_speed_slider = createSlider(atom.min_speed, atom.max_speed, atom.max_speed/5, 1); // min max start step
            atom_speed_slider.position(w + 160, h);
            atom_speed_slider.style('width', '80px');
            speed_display = createP();
            speed_display.position(w + 160, h+5);

            angle_slider = createSlider(0, 360, 0, 15); // min max start step
            angle_slider.position(w + 40, h);
            angle_slider.style('width', '80px');
            angle_display = createP();
            angle_display.position(w + 45, h+5);

            atom_source_select = createSelect();
            atom_source_select.position(w - 250, h);
            atom_source_select.option('Oven');
            atom_source_select.option('Spin Up (Z+)');
            atom_source_select.option('Spin Down (Z-)');
            atom_source_select.changed(sourceSelected);

            autofire_checkbox = createCheckbox('Autofire', false);
            autofire_checkbox.position(w - 50, h - 20);
            autofire_checkbox.changed(toggleAutofire);

            counter = createP();
            counter.position(50, h);

            percent_counter = createP();
            percent_counter.position(50, h - 20);
        }

        function sourceSelected () {
            atom_source = atom_source_select.value();
            reset();
        }

        function toggleAutofire() {
            autofire = autofire_checkbox.checked() ? true : false;
        }

        function windowResized() {
            resizeCanvas(0.9*windowWidth, 0.8*windowHeight);
            repositionInteractiveComponents();
        }   

        function repositionInteractiveComponents() {
            let h = 0.95*windowHeight;
            let w = windowWidth/2;
            reset_button.position(w - 120, h);
            fire_button.position(w - 50, h);
            atom_speed_slider.position(w + 160, h);
            speed_display.position(w + 160, h + 5);
            angle_slider.position(w + 40, h);
            angle_display.position(w + 45, h + 5);
            atom_source_select.position(w - 250, h);
            autofire_checkbox.position(w - 50, h - 20);
            counter.position(50, h);
        }

        function drawHTML() {
            let percent_spin_up = ceil(100 * num_spin_up / (num_spin_up + num_spin_down));
            let percent_spin_down = 100 - percent_spin_up;
            if (num_spin_up == 0) { 
                percent_spin_up = 0;
                percent_spin_down = 0;
            }
            counter.html('# spin up (red): ' + num_spin_up + '     # spin down (blue): ' + num_spin_down);
            percent_counter.html('spin up (red): ' + percent_spin_up + '%     ' + 'spin down (blue): ' + percent_spin_down + '%');
            angle_display.html(angle_slider.value() + 'Â°'); // Display angle value under slider
            speed_display.html('Speed: ' + atom_speed_slider.value());
        }
      
        function drawAxis() {
            push(); 
            let x = 15;
            let y = 15;
            let z = 15;
            line(-x, 0, 0, x, 0, 0); // l to r (x)
            line(0, -y, 0, 0, y, 0); // d to u (y)
            line(0, 0, -z, 0, 0, z); // f to b (z)
            pop();
        }

        function drawPerspectiveLine() {
            push();
            line(perspective_line.p1.x, perspective_line.p1.y, perspective_line.p1.z, 
                 perspective_line.p2.x, perspective_line.p2.y, perspective_line.p2.z);
            pop();
        }

        function drawPlatform() {
            push(); 
            rotateX(90);
            translate(0, 0, platform.height);
            plane(platform.length, platform.width, 1, 1);
            pop();
        }

        function drawOven() {
            push();
            fill(150, 150, 150); // Dark grey
            translate(oven.x, oven.y, oven.z);
            box(oven.width, oven.height, oven.length);
            pop();
        }

        function drawAtomSource() {
            if (atom_source == 'Oven') {
                drawOven();
            } else { 
                drawSourceMagnet();
                push();
                colorAtom();
                pop();
            }
        }

        function drawDetectorScreen() {
            push(); 
            detector.angle = angle_slider.value();                      
            rotateX(detector.angle);         // uncomment to rotate magnets by 90      
            fill(220, 220, 220); // Light grey
            translate(detector.x, 0, 0);
            rotateY(90);
            plane(detector.width, detector.height); // width, height
            pop();
        }

        function drawMagnet() {
            push();  
            magnet.angle = angle_slider.value();                      
            rotateX(magnet.angle); 

            /* TOP */
            push();
            smooth();
            fill(240, 130, 130);
            translate(0, -magnet.gap/2, 0);
            box(magnet.length, magnet.height, magnet.width);
            pop();

            //top add on
            push();
            smooth();
            fill(240, 130, 130);
            translate(0, -magnet.gap/2 + magnet.height/2 - 8, 0);
            rotateX(45);
            box(magnet.length - 2, magnet.height - 3, magnet.height - 3);
            pop();
            /* END TOP */

            
            /* BOTTOM */
            push();
            smooth();
            fill(130, 150, 220);
            translate(0, magnet.gap/2, 0);
            box(magnet.length, magnet.height, magnet.width);
            pop();

            // bottom add ons
            push();
            smooth();
            fill(150, 170, 240);
            translate(0, magnet.gap/2 - 10, magnet.width/2.75);
            box(magnet.length - 2, magnet.height, magnet.width/4);
            pop();

            push();
            smooth();
            fill(150, 170, 240);
            translate(0, magnet.gap/2 - 10, -magnet.width/2.75);
            box(magnet.length - 2, magnet.height, magnet.width/4);
            pop();
            /* END BOTTOM */

            pop();
        }

        function drawSourceMagnet() {
            push();  
            translate(-platform.length/1.5, 0, 0);

            /* TOP */
            push();
            smooth();
            fill(240, 130, 130);
            translate(0, -magnet.gap/2, 0);
            box(magnet.length, magnet.height, magnet.width);
            pop();

            //top add on
            push();
            smooth();
            fill(240, 130, 130);
            translate(0, -magnet.gap/2 + magnet.height/2 - 8, 0);
            rotateX(45);
            box(magnet.length - 2, magnet.height - 3, magnet.height - 3);
            pop();
            /* END TOP */

            /* BOTTOM */
            push();
            smooth();
            fill(130, 150, 220);
            translate(0, magnet.gap/2, 0);
            box(magnet.length, magnet.height, magnet.width);
            pop();

            // bottom add ons
            push();
            smooth();
            fill(150, 170, 240);
            translate(0, magnet.gap/2 - 10, magnet.width/2.75);
            box(magnet.length - 2, magnet.height, magnet.width/4);
            pop();

            push();
            smooth();
            fill(150, 170, 240);
            translate(0, magnet.gap/2 - 10, -magnet.width/2.75);
            box(magnet.length - 2, magnet.height, magnet.width/4);
            pop();
            /* END BOTTOM */

            pop();
        }
 
        function drawAtom(spin, x, y, z) {
            // drawSpinVector(spin, x, y, z);
            push();
            // atom.radius = atom_radius_slider.value(); // Uncomment To allow user to change radius of atom
            let angle = angle_slider.value();
            rotateX(angle); // Rotate atom trajectory by the same angle of the magnet
            translate(x, y, z);
            strokeWeight(stroke_weight);
            colorAtom();
            sphere(atom.radius, atom.detailX, atom.detailY);
            pop();
        }

        function chooseAtomSpin() {
            if (atomEnteredMagnet()) {
                let angle = angle_slider.value();
                let r = random(100) / 100;
                let p = sq(cos(angle/2));

                if (atom_source == 'Spin Up (Z+)') {
                    if (r <= p)
                        atom.spin = up;
                    else
                        atom.spin = down;
                    spin_chosen = true;
                } else if (atom_source == 'Spin Down (Z-)') {
                    if (r <= p)
                        atom.spin = down;
                    else   
                        atom.spin = up;
                    spin_chosen = true;
                }
            }
        }

        function hasChosenSpin() {
            return spin_chosen;
        }

        function colorAtom() {
            if (atom.spin == up && atomEnteredMagnet())
                fill(250, 100, 100); // Red
            else if (atom.spin == down && atomEnteredMagnet())
                fill(60, 80, 240); // Blue
            else if (atom_source == 'Spin Up (Z+)' && !atomEnteredMagnet())
                fill(250, 100, 100); // Red
            else if (atom_source == 'Spin Down (Z-)' && !atomEnteredMagnet())
                fill(60, 80, 240); // Blue
            else
                fill(200,200,200); // Grey
        }

        function setSpin() {
            if (atom_source == 'Oven') 
                atom.spin = floor(random(2) % 2) == 0 ? up : down;
            else if (atom_source == 'Spin Up (Z+)') 
                atom.spin = up;
            else if (atom_source == 'Spin Down (Z-)') 
                atom.spin = down;
        }

        function fireAtom(spin) {
            if (atomEnteredMagnet() && !hasChosenSpin())
                chooseAtomSpin();
                
            if (!atomHitDetector()) { // Atom has not hit detector screen
                fire = true;
                computeAtomTrajectory();
            } else if (atomHitDetector() && autofire) {
                incrementAtomCounter();
                resetAtom();
            } else if (atomHitDetector() && !autofire) {
                fire = false;
                atom.pos.x = atom.end.x;
                incrementAtomCounter();
            }
            drawAtom(atom.spin, atom.pos.x, atom.pos.y, atom.pos.z);
        }


        function atomEnteredMagnet() {
            return atom.pos.x + atom.radius > magnet.entrance_x;
        }

        function atomHitDetector() {
            return (norm(atom.pos.x, atom.start.x, atom.end.x) >= 1.0) ? true : false;
        }

        function computeAtomTrajectory() {
            atom.speed = atom_speed_slider.value();
            atom.pos.x += atom.speed;
            let curve_distance_percent = norm(atom.pos.x, atom.start.x, atom.end.x);

            let p = getCubicBezierXYatPercent(
                trajectory.start,
                trajectory.p1,
                trajectory.p2,
                trajectory.end,
                curve_distance_percent
            );
            atom.pos.y = p.y;
            if (atom.spin == up)
                atom.pos.y *= -1;
        }   

        /* REFERENCE FOR getCubicBezierXYatPercent and cubicN:
            https://stackoverflow.com/questions/17083580/i-want-to-do-animation-of-an-object-along-a-particular-path 
         */
        // cubic bezier percent is 0-1
        // Note that currently only the y result is used, but leaving the x and z for future use.
        function getCubicBezierXYatPercent(startPt,controlPt1,controlPt2,endPt,percent){
            let x = cubicN(percent,startPt.x,controlPt1.x,controlPt2.x,endPt.x);
            let y = cubicN(percent,startPt.y,controlPt1.y,controlPt2.y,endPt.y);
            let z = cubicN(percent,startPt.z,controlPt1.z,controlPt2.z,endPt.z);
            return({x: x, y: y, z: z});
        }

        // cubic bezier helper formula at percent distance
        function cubicN(pct,a,b,c,d) {
            let t2 = pct * pct;
            let t3 = t2 * pct;
            return a + (-a * 3 + pct * (3 * a - a * pct)) * pct
            + (3 * b + pct * (-6 * b + b * 3 * pct)) * pct
            + (c * 3 - c * 3 * pct) * t2
            + d * t3;
        }

        function incrementAtomCounter() {
            (atom.spin == up) ? num_spin_up++ : num_spin_down++; // Add to counter
        }

        function fireSingleAtom() {
            resetAtom();
            fireAtom(atom.spin);
        }

        function resetAtom() {
            setSpin();
            spin_chosen = false;
            atom.pos.x = atom.start.x;
            atom.pos.y = atom.start.y;
            atom.pos.z = atom.start.z;
            dx = 0;
            dy = 0;
            dz = 0;
            i = 0;
        }

        function reset() {
            resetAtom();
            num_spin_down = 0;
            num_spin_up = 0;
        }
        

    </script>

    <!-- p5.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.1/p5.min.js" integrity="sha512-NxocnqsXP3zm0Xb42zqVMvjQIktKEpTIbCXXyhBPxqGZHqhcOXHs4pXI/GoZ8lE+2NJONRifuBpi9DxC58L0Lw==" crossorigin="anonymous" referrerpolicy="no-referrer">
    </script>

</body>
</html>